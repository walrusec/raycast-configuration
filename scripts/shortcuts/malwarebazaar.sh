#!/bin/bash

# Required parameters:
# @raycast.schemaVersion 1
# @raycast.title MalwareBazaar
# @raycast.mode silent
# @raycast.packageName |  Quicklink

# Optional parameters:
# @raycast.icon https://bazaar.abuse.ch/favicon.ico
# @raycast.argument1 { "type": "text", "placeholder": "imphash/tag", "optional": true }

# Documentation:
# @raycast.author https://github.com/walrusec/walrusec
# @raycast.description Uses the clipboard. Expects a hash. If run with no arguments, it will open Malwarebazaar for the hash. If you want to search an imphash, you must include i, im, imh, or imphash in the optional parameter. If you use any other string in the parameter, it will override and run a tag search. ie qakbot.
source ../bash.lib

input=$(sanitize "$(pbpaste)")
len=${#input}

if [ -n "$1" ]; then
    
    if [ "$1" = imp ] ||  [ "$1" = im ] ||  [ "$1" = i ] ||  [ "$1" = imphash ]; then
        open -a "Google Chrome" "https://bazaar.abuse.ch/browse.php?search=imphash%3A$input" 
    
    else
        open -a "Google Chrome" "https://bazaar.abuse.ch/browse.php?search=tag%3A$1"
    
    fi

elif [ "$len" -eq 32 ]; then
    open -a "Google Chrome" "https://bazaar.abuse.ch/browse.php?search=md5%3A$input"

elif [ "$len" -eq 40 ]; then
    echo "Sha1 is not supported in Malware Bazaar"

elif [ "$len" -eq 64 ]; then
    open -a "Google Chrome" "https://bazaar.abuse.ch/sample/$input"

fi
